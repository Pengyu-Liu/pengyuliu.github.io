---
title: 'TRAP4vAPP Finding exoplanets in vAPP coronagraphic data'
date: 2020-10-11
permalink: /posts/2020/TRAP4vAPP Finding exoplanets in vAPP coronagraphic data

---

This is a blog that records my master project TRAP4vAPP Finding exoplanets in vAPP coronagraphic data and courses at Leiden Observatory 2020-2021.

## Week 7

### 11 Oct 2020

Moved the progress record from the former google sheet to this site. Finished all the steps for one wavelength channel. But the result is not as good as my old method. The planets are not obvious. I tried at least 3 ways to extract star intensity: use the star model, fit the star model(shifted) to the decentered bkg_subtacted images(mean(optimal)=~1.1), fit star model to the aligned bkg_subtacted images and shift(mean(optimal)=1.00...). Also for science frames PCA, I tried masking planets or not when building basis and it seems I should not mask planets(results are different). I fitted the basis to every frame with planets masked. What I have tried today still cannot give a better result than my old way and even worse. There must be something wrong in middle steps. The first picture is my old method and the second is today's result. Debug tomorrow!




### 12 Oct 2020
Go through all the steps to check if there are some bugs in the code, and didn't find one. Increased PCA group number from 5 to 8 to increase precisions. No big differences than yesterday. After trying many possibilities, masking planets when fitting PCA basis can increase planets' signal a little bit, so need to mask; fitting low order polynomial does remove residual big structures(static noise), so need to do; fitting star model should only use extract star model part; the difference between fitting first shift later or shiftt first fitting later is small, and I can keep the same as David's method right now; subtracting mean value at first when doing PCA doesn't have a big influence and I don't subtract the mean. The possible improvement or problem I think lies in PCA modelling science frames. Because I cannot subtract star intensity totally, there are still some remained. When doing PCA, the frames are not aligned, so the remaining star intensity has a big influence on the PCA basis construction. I checked the first 10 compenents:the first is sky bkg, others are all about the central star. I need to evaluate how many components I should use tomorrow. Also I put the simple method to a new notebook and its result is better than the complex one. Tomorrow I need to try new wavelength channels(I tried some tonight and found that I cannot just use the same code. There are many differences between channels.) Another thing is the final image on David's paper is a combination of wavelength slices. No wonder my single image is not as good as that one! I was stuck for a long time to try to get a similar one as his by using just one channel... Wasted a lot of time because didn't read carefully.

### 13 Oct 2020
Compared three methods: old, new, new(mask star), and the result of the old method is the best. Plot three contrast curves. As for the PCA components, 10 is enough.

### 14 Oct 2020
Weekly meeting with supervisors: Matthew and Alex said I should set plots with the same scale (colorbar and x,y axis) and put curves in the same plot so that people can compare them. It is very important. Next week I will implement my code on all channels and try to inject negative planet. 

### 15 Oct 2020
Implemented my simple method to all wavelength channels. For very short and long wave, it needs to set different initial values when doing gaussian fitting to determine the location of stars. I checked all star models for each channel(1-100) by eye. Is there any code can do this for me? I always check the fitting results just by eye... One wrong fitting result for the star PSF shift is 'beautiful' and cheers me up at midnight coding. The rough combination of all channels seems good.
![](https://raw.githubusercontent.com/Pengyu-Liu/Pengyu-Liu.github.io/master/images/blogs/PSF%20wrong%20shift.png)

### 16 Oct 2020
Plot out raw planets spectra and they are flat.

### 17 Oct 2020
Studied the course NUR.

## Week 8

### 18 Oct 2020
Read the fake paper injection paper and thought about how to compare different post-processing algorithms: 5-sigma dection limit, false positve fraction and contrast curve. Not sure I should compare them now or at later stage. Watched ISM course video of last Friday.

### 19 Oct 2020
Finished other two methods on all wavelength channels. The planet spectra are roughly the same, but they behave differently near 3.4um. 

### 20 Oct 2020
Thought about the project: algorithms I can implement, how to compare them and next steps. Tried to understand the LOCI paper, but failed.

### 21 Oct 2020
Weekly group meeting: Matthew said don't use loci. Good news is that Alex said Mattias is going to publish his TRAP paper and I can start to work on TRAP in next one or two weeks. For this week, inject fake planets to obtain real planets spectra.

### 22 Oct 2020
Started to write the fake planet routine. Have some questions about how to implement the algorithm. The main problem is how to minimize the function: use the downhill simplex method(I just learned it in NUR) or simple iterations?

### 23 Oct 2020
Sent an email to ask Alex about my questions. Joined the Amsterdam physics and astronomy career days. Worked on NUR assignment2.

### 24 Oct 2020
Worked on NUR assignment2 and finished one small question.

## Week 9

### 25 Oct 2020
Wrote the fake planet injection routine, using Hessian merit function and Nelder-Mead minimization method. Did 7 experiments to inject planets in cube60. Planet c and e can be subrtacted well, while d still remains some flux.(optimize positions and amplitude) The optimization is very time consuming: about 1h for one planet in one cube! 

### 26 Oct 2020
Tried another merit function(flux absolute residual) and tolerance. The problem is this method cannot return the right positions. It always goes to another location where the merit function is smallest. The results are not good as fixing the planet position by eye. 

### 27 Oct 2020
Subtract planet c successfully(from 90 cubes)! But planet e is not subtracted totally. Still the location problem.

### 28 Oct 2020
Weekly meeting: Alex suggested to fix the mask when optimizing the locations. I also thought of adding constraints on the locations could be tested.

### 29 Oct 2020
Listened a faculty presentation. It is hard to get a position.

### 30 Oct 2020
Handed in NUR handin2 exercise at 23:59. Flag: finish next assigment one day before the deadline.

### 31 Oct 2020
rest.

## Week 10
### 1 Nov 2020
Read the fisrt 2 sections of the trap paper. At the same time, fixed the circular mask for negative planet e injection. 
### 2 Nov 2020
Read the trap paper.

### 3 Nov 2020
It's a great meeting with Matthias. I can start with the main part of my project now.

### 4 Nov 2020
Weekly meeting with Alex: Now I should focus on TRAP and make it work. Aperture photometry is left to later stages. The trap tutorial can work except some custom plotting style. 

### 5 Nov 2020
Studied NUR and ISM. Played FFT on my data.

### 6 Nov 2020
Watched the NUR videos. Too much left.

### 7 Nov 2020
Split the unbinned data.

## Week 11
### 8 Nov 2020
Put my data into Matthias' trap code. There are some bugs.

### 9 Nov 2020
Gave up modifying Matthias' code (too many routines that I might not use) and began to write my own code from scratch. Built up trap code for one pixel using simple conditions. Need to wrap the code for all pixels in a search region tomorrow.

### 10 Nov 2020
Implemented trap from separation 1 to 25 pixels. The detection_map didn't show any planet signals. There must be something wrong about my code.
![](https://raw.githubusercontent.com/Pengyu-Liu/Pengyu-Liu.github.io/master/images/blogs/trap1011.png)

### 11 Nov 2020
Weekly group meeting: Three supervisors agreed to modify Matthias' code to work on the vAPP data, because it's the easist to work on instead of writing your code.

### 12 Nov 2020
Worked hard on debugging the trap code and run out the first trap image of vapp data. 

### 13 Nov 2020
Wrote CV.

### 14 Nov 2020
Went out.

## Week 12
### 15 Nov 2020
Wrote a cover letter. Daily routine becomes irregular again.

### 16 Nov 2020
Lost in the TRAP code and finally found out.

### 17 Nov 2020
Tested TRAP parameters to get out planet e.

### 18 Nov 2020
Got fresh results on the smaller number of PCA components and it was better than previous results. Weekly meeting: continue to test the parameters; Matthew reminded me to be aware of the projects' final goals and manage my time. Updated the project timeline on drive. It made me worried that there are not too many creative things I can do in this project? But I should know more about vAPP coronagraph.

### 19 Nov 2020
Modified code to make it run on the observartory's desktop. The running speed is much slower than on my laptop, but the hardware configuration is better than mine. I made it run on 3 cores, strange thing. Today I was testing enlarging the PSF size and decreasing frac. 

### 20 Nov 2020
Ran my code on two computers.

### 21 Nov 2020
Add another components fraction and ran it on another computer. The running speed was very low.

## Week 13

### 22 Nov 2020
Organized my experiments notes. Worked on NUR handin3.

### 23 Nov 2020
Compared the results of different fraction numbers and mask sizes. Spent several hours on understanding 5 sigma detection limit.

### 24 Nov 2020
Added a circular mask to exclude the inner most region from regressor pixels. It improved the contrast in outer regions. The results of other wavelengths showed that TRAP worked well.

### 25 Nov 2020
Weekly meeting: talked about what I did last week and discussed the direction of this project. My poor English...

### 26 Nov 2020
Worked on NUR.

### 27 Nov 2020
Thought of how to get the temporal variations by TRAP and compare them with David's results.

### 28 Nov 2020
Added a fake source to a data cube and waited for the result.

## Week 14
### 29 Nov
Cleaned code of NUR Handin3 and wrapped them.

### 30 Nov
Wrote the report of NUR handin3. Sent my rough spectra of conventional methods to David.

### 1 Dec
Modifying code written by other people is not what I like to do, especially for thousands of lines. I spent more than 6 hours to find out why one routine(addsource) did't work for outer points. Then it took another 2 hours to modify it. I also found a mistake in trap code. Finanlly, TRAP could run for smaller frames tonight, but couldnot detect planet signals. Sad.

### 2 Dec
Weekly meeting: David thought it should work for half of the frammes for the same linear equations. I was also confused. 

### 3 Dec
Met with Matthias: he said when you cut down half of data, it can influence the results, like lower snr. Matthias also introduced some advanced use of TRAP code and it helped a lot. I should contact Matthias earlier.

### 4 Dec
Made TRAP running on several servers.

### 5 Dec
One day off.

## Week 15
### 6 Dec
My server was shutdown. I went to turn it on and didn't figure out what was the reason.

### 7 Dec 
Fitted the location of a planet. Thought about how to read contrast for each pixels.

### 8 Dec
The results of most channels have come out. Measured the planets spectra using interpolation and trap for one position.

### 9 Dec
Weekly meeting: Frans suggested to add a linear factor(with time) to the forward model and see its influence on the contrast.

### 10 Dec
Finally all channels were finished. I used 6 computers including a cluster. Probably there was something wrong with the multipleprocess. I should find a time to update trap code to the latest version and figure out the problem of linux tqdm.

### 11 Dec
Watched NUR course videos.

### 12 Dec
One day off.

## Week 16

### 13 Dec
Tested on temporal variations using my two methods. It's hard to tell variations from these results.

### 14 Dec 
Forgot what I have done. Probably played TRAP on temporal variations.

### 15 Dec
Added a linear factor with time to the forward mode. 

### 16 Dec
Injected a fake positive planets and retrieved it constrast. Had a weekly meeting. Started a break for my project until I finish my exams in early Jan. 

### 17 Dec
Wanted to fix the planet location, but didn't try. 

### 18 Dec 
Talked with several people and reviewed NUR last two courses.

### 19 Dec 
Started to work on NUR handin4 from night. Simulated the solar system in python this time. Last time I simulated the solar system was the first year in my bachelor. I used C 5 years ago and thought it was a hard and big assignment since it cost me several days. This time only a few hours. I am in a new level in programming :).

## Week 17

### 20 Dec
Worked on NUR handin4.

### 21 Dec
Wrote the report of the first question for NUR handin4.

### 22 Dec
Finally finished the last assignment. NUR assignments season was finally over. It was the most time-consuming course in my master. I also learned some git skills today.

## Week 18-19

NUR and ISM exams

## Week 20

### 10-11 Jan
Prepared for an interview. The efficiency was low when I reflected on myself.

### 12 Jan
Updated the version of TRAP. 

### 13 Jan
Read one paper.

### 14 Jan
Joined a workshop and prepared for the presentation.

### 15 Jan
Interview and talked with classmates.

### 16 Jan
One day off. It was snowing in Leiden!

## Week 20

### 17 Jan
Read two papers on HCI comparison and thought about how to compare my results. Wanted to use some statistical knowledge I learned.

